// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t){return document.getElementById(t)}function a(t){return t+"px"}function e(t,a){return null!==t&&hasOwnProperty.call(t,a)}function n(t){if(t){var a=t.split(".");if(!(a.length<1)&&(a=a[0].split("-"),a[0]=a[0].replace(/\D/g,""),a[0]))return a[1]=a[1]?a[1].replace(/\D/g,""):"1",a[2]=a[2]?a[2].replace(/\D/g,""):"1",new Date(a[0],a[1]-1,a[2])}}function r(t,a,e){var n,r=t.valueOf();if(!a)return new Date(r);switch(n=e||"d"){case"y":case"yr":r+=31556926080*a;break;case"m":case"mo":r+=26298e5*a;break;case"d":case"dy":r+=864e5*a;break;case"h":case"hr":r+=36e5*a;break;case"n":case"mn":r+=6e4*a;break;case"s":case"sec":r+=1e3*a;break;case"ms":r+=a}return new Date(r)}function s(t,a,e){var n,r;if(a&&t){switch(n=a.valueOf()-t.valueOf(),r=e||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3;break;case"ms":}return n}}function i(t){return(t.getHours()+t.getTimezoneOffset()/60+t.getMinutes()/60+t.getSeconds()/3600)/24}function o(t,a){for(var e=a>1?t*t:-t*t,n=a*e*t/6,r=(1-a)*t-n,s=4;Math.abs(n)>1e-15;)n*=e/(s*(s+1)),r-=n,s+=2;return r}function h(t){var a,e,n,r,s=t.e,i=t.M,h=1e-8,c=0,u=1.9,l=!1,f=0;if(!i)return 0;if(1>s&&((i<-Math.PI||i>Math.PI)&&(r=g.normalize0(i),c=i-r,i=r),.9>s)){a=Math.atan2(Math.sin(i),Math.cos(i)-s);do e=(a-s*Math.sin(a)-i)/(1-s*Math.cos(a)),a-=e;while(Math.abs(e)>h);return a}if(0>i&&(i=-i,l=!0),a=i,h*=Math.abs(1-s),1e-15>h&&(h=1e-15),(s>.8&&i<Math.PI/3||s>1)&&(n=i/Math.abs(1-s),n*n>6*Math.abs(1-s)&&(n=i<Math.PI?Math.pow(6*i,1/3):g.asinh(i/s)),a=n),s>1&&i>4&&(a=Math.log(i)),1>s)for(;Math.abs(u)>h;)e=f++>8?o(a,s)-i:a-s*Math.sin(a)-i,u=-e/(1-s*Math.cos(a)),a+=u;else for(;Math.abs(u)>h;)e=f++>7?-o(a,s)-i:s*g.sinh(a)-a-i,u=-e/(s*g.cosh(a)-1),a+=u;return l?c-a:c+a}function c(t){var a,e,n,r,s;1===t.e?(s=t.jd0-t.T,r=t.w0*s*.5,e=Math.pow(r+Math.sqrt(r*r+1),1/3),t.v=2*Math.atan(e-1/e)):(t.E=h(t),t.e>1?(a=t.e-g.cosh(t.E),e=g.sinh(t.E)):(a=Math.cos(t.E)-t.e,e=Math.sin(t.E)),e*=Math.sqrt(Math.abs(1-t.e*t.e)),t.v=Math.atan2(e,a)),n=t.q*(1+t.e),t.r=n/(1+t.e*Math.cos(t.v))}function u(t){t.hasOwnProperty("w")||(t.w=t.W-t.N),t.hasOwnProperty("M")||(t.M=t.L-t.W),t.e<1&&(t.M=g.normalize0(t.M)),t.P=Math.pow(Math.abs(t.a),1.5),t.T=t.jd0-t.M/Math.PI/2/t.P,1!==t.e?(t.q=t.a*(1-t.e),t.t0=t.a*Math.sqrt(Math.abs(t.a)/m)):(t.w0=3/Math.sqrt(2)/(t.q*Math.sqrt(t.q/m)),t.a=0,t.t0=0),t.am=Math.sqrt(m*t.q*(1+t.e))}function l(t){var a,e,n,r=t.v+t.w;return a=t.r*(Math.cos(t.N)*Math.cos(r)-Math.sin(t.N)*Math.sin(r)*Math.cos(t.i)),e=t.r*(Math.sin(t.N)*Math.cos(r)+Math.cos(t.N)*Math.sin(r)*Math.cos(t.i)),n=t.r*(Math.sin(r)*Math.sin(t.i)),t.x=a,t.y=e,t.z=n,{x:a,y:e,z:n}}function f(t){var a,e,n,r=t.getUTCFullYear(),s=t.getUTCMonth()+1,o=t.getUTCDate(),h=i(t),c=0,u=0,l=2400000.5,f=-4799,d=[31,28,31,30,31,30,31,31,30,31,30,31];return f>r?-1:1>s||s>12?-2:(2!==s||r%4!==0||r%100===0&&r%400!==0||(u=1),(1>o||o>d[s-1]+u)&&(c=-3),a=(s-14)/12,e=r+a,n=1461*(e+4800)/4+367*(s-2-12*a)/12-3*((e+4900)/100)/4+o-2432076,n+l+h)}var d=function(t,a){for(var e=[],n=0;3>n;n++){for(var r=0,s=0;3>s;s++)r+=t[n][s]*a[s];e[n]=r}return e},M=function(t,a){for(var e=[],n=0;3>n;n++){e[n]=[];for(var r=0;3>r;r++){for(var s=0,i=0;3>i;i++)s+=a[n][i]*t[i][r];e[n][r]=s}}return e},p=function(t){return M(w("z",t[2]),w("x",t[0]))},w=function(t,a){var e=-a*Math.PI/180,n=Math.cos(e),r=Math.sin(e);switch(t){case"x":return[[1,0,0],[0,n,r],[0,-r,n]];case"y":return[[n,0,-r],[0,1,0],[r,0,n]];case"z":return[[n,r,0],[-r,n,0],[0,0,1]]}},g={sinh:function(t){return(Math.pow(Math.E,t)-Math.pow(Math.E,-t))/2},cosh:function(t){return(Math.pow(Math.E,t)+Math.pow(Math.E,-t))/2},tanh:function(t){return 2/(1+Math.exp(-2*t))-1},asinh:function(t){return Math.log(t+Math.sqrt(t*t+1))},acosh:function(t){return Math.log(t+Math.sqrt(t*t-1))},normalize0:function(t){return(t+3*Math.PI)%(2*Math.PI)-Math.PI},normalize:function(t){return(t+2*Math.PI)%(2*Math.PI)},deg2rad:function(t){return t*Math.PI/180},hour2rad:function(t){return t*Math.PI/12},rad2deg:function(t){return 180*t/Math.PI},rad2hour:function(t){return 12*t/Math.PI}},m=Math.pow(.01720209895,2),v=function(t,a,r){var s,i,o,h={},d=["a","e","i","w","M","L","W","N","n"];for(r&&(m=r),a&&(s=a instanceof Date?a:n(a)),s||(s=new Date),h.jd=f(s),s=n(t.ep),h.jd0=f(s),h.d=h.jd-h.jd0,h.cy=h.d/36525,i=0;i<d.length;i++)o=d[i],e(t,"d"+o)?h[o]=t[o]+t["d"+o]*h.cy:e(t,o)&&(h[o]=t[o]),e(h,o)&&(-1===o.search(/a|e/)?h[o]*=Math.PI/180:h[o]*=1);return e(h,"M")&&!e(h,"dM")&&e(h,"n")&&(h.M+=h.n*h.d),u(h),c(h),l(h),h},y=function(t,a){if(!(a.elements.length>1)){var e=a.elements[0],n=v(e,t),r={name:a.name,pos:[n.x,n.y,n.z]};return a.H&&""!==a.H?r.r=12-a.H:a.r&&""!==a.r?r.r=a.r:r.r=20,a.icon&&""!==a.icon&&(r.icon=a.icon),r}},b=function(t,a){for(var e,n=a.elements[0],i=[],o=v(n,t),h=o.P,c=r(t,h,"y"),u=s(t,c)/90/o.a,l=new Date(t.valueOf());s(l,c)>0;)e=v(n,l),i.push([e.x,e.y,e.z]),l=r(l,u);return i.push([o.x,o.y,o.z]),i},P={width:0,height:0,background:"#000000",container:"map",datapath:"data/",planets:{show:!0,image:!0,trajectory:!0,size:null},sbos:{show:!0,image:!1,text:!0,trajectory:!1,size:null},spacecraft:{show:!0,image:!1,text:!0,trajectory:!1,size:null},other:[],set:function(t){var a,n={};if(!t)return this;for(var r in this)if(e(this,r)&&"function"!=typeof this[r])if(e(t,r)&&null!==t[r])if(null===this[r]||this[r].constructor!=Object)n[r]=t[r];else{n[r]={};for(a in this[r])e(t[r],a)?n[r][a]=t[r][a]:n[r][a]=this[r][a]}else n[r]=this[r];return n}},z={version:"0.2",svg:null};z.display=function(n){function r(){k.width&&k.width>0||(D=q?q.clientWidth:window.innerWidth,H=q?q.clientHeight:window.innerHeight,A.attr("width",D).attr("height",H),C.attr("transform","translate("+D/2+","+H/2+")"),o())}function s(t){var a=[];return t.forEach(function(t){for(var e=[],n=0;n<t.length;n++){var r=d(O,t[n]);r[0]*=I,r[2]*=I,e.push([r[0],-r[2]])}a.push(e)}),a}function i(t){var a=d(O,t.pos),e=t.r/2,n="Saturn"==t.name?1.35*t.r:e;return a[0]*=I,a[2]*=I,e&&(a[0]-=n,a[2]+=e),"translate("+a[0]+","+-a[2]+")"}function o(){if(I=T.scale(),"wheel"!==d3.event.sourceEvent.type){var t=T.translate();j=[30-N(t[1]),0,90+W(t[0])],O=p(j)}S=Math.pow(I,.8),c.attr({x:-S/2,y:-S/2,width:S,height:S}),u.attr("transform",i),h=s(m),l.data(h).attr("d",U),M.attr("transform",i)}var h,c,u,l,f,M,w=[],g=[],m=[],v=[],z=new Date,j=[30,0,90],I=60,x=null,k=P.set(n),q=t(k.container);if(q){x="#"+k.container;var E=window.getComputedStyle(q,null);parseInt(E.width)||k.width||(q.style.width=a(window.innerWidth)),parseInt(E.height)||k.height||(q.style.height=a(window.innerHeight))}else x="body",q=null;var D=q?q.clientWidth:window.innerWidth,H=q?q.clientHeight:window.innerHeight,O=p(j),W=d3.scale.linear().domain([-D/2,D/2]).range([-360,360]),N=d3.scale.linear().domain([-H/2,H/2]).range([90,-90]).clamp(!0),T=d3.behavior.zoom().center([0,0]).scaleExtent([10,150]).scale(I).on("zoom",o),A=d3.select(x).append("svg").attr("width",D).attr("height",H).call(T),C=A.append("g").attr("transform","translate("+D/2+","+H/2+")"),S=Math.pow(I,.8);c=C.append("image").attr({"xlink:href":"img/sun.png",x:-S/2,y:-S/2,width:S,height:S});var U=d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]});k.planets.show&&d3.json("data/planets.json",function(t,a){if(t)return console.log(t);for(var n in a)e(a,n)&&(w.push(y(z,a[n])),k.planets.trajectory&&e(a[n],"trajectory")&&m.push(b(z,a[n])));k.planets.trajectory&&(h=s(m),l=C.selectAll(".tracks").data(h).enter().append("path").attr("class","dot").attr("d",U)),k.planets.image&&(u=C.selectAll(".planets").data(w).enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",i).attr("class","planet").attr("width",function(t){return"Saturn"==t.name?2.7*t.r:t.r}).attr("height",function(t){return t.r}))}),k.sbos.show&&d3.json("data/sbo.json",function(t,a){if(t)return console.log(t);for(var n in a)e(a,n)&&a[n].H<11&&g.push(y(z,a[n]));M=C.selectAll(".sbos").data(g).enter().append("path").attr("transform",i).attr("class","sbo").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),k.spacecraft.show&&d3.json("data/probes.json",function(t,a){if(t)return console.log(t);for(var n in a)if(e(a,n)){var r=y(z,a[n]);r&&v.push(r)}k.spacecraft.image?f=C.selectAll(".probes").data(v).enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",i).attr("class","planet").attr("width",20).attr("height",20):M=C.selectAll(".probes").data(v).enter().append("path").attr("transform",i).attr("class","planet").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),d3.select(window).on("resize",r)},this.Orrery=z}();