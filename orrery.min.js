// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function e(e){return document.getElementById(e)}function t(e){return e+"px"}function a(e,t){return null!==e&&hasOwnProperty.call(e,t)}function r(e){if(e){var t=e.split(".");if(!(t.length<1)&&(t=t[0].split("-"),t[0]=t[0].replace(/\D/g,""),t[0]))return t[1]=t[1]?t[1].replace(/\D/g,""):"1",t[2]=t[2]?t[2].replace(/\D/g,""):"1",new Date(t[0],t[1]-1,t[2])}}function n(e,t,a){var r,n=e.valueOf();if(!t)return new Date(n);switch(r=a||"d"){case"y":case"yr":n+=31556926080*t;break;case"m":case"mo":n+=26298e5*t;break;case"d":case"dy":n+=864e5*t;break;case"h":case"hr":n+=36e5*t;break;case"n":case"mn":n+=6e4*t;break;case"s":case"sec":n+=1e3*t;break;case"ms":n+=t}return new Date(n)}function i(e,t,a){var r,n;if(t&&e){switch(r=t.valueOf()-e.valueOf(),n=a||"d"){case"y":case"yr":r/=31556926080;break;case"m":case"mo":r/=26298e5;break;case"d":case"dy":r/=864e5;break;case"h":case"hr":r/=36e5;break;case"n":case"mn":r/=6e4;break;case"s":case"sec":r/=1e3;break;case"ms":}return r}}function s(e){return(e.getHours()+e.getTimezoneOffset()/60+e.getMinutes()/60+e.getSeconds()/3600)/24}function o(e,t){for(var a=t>1?e*e:-e*e,r=t*a*e/6,n=(1-t)*e-r,i=4;Math.abs(r)>1e-15;)r*=a/(i*(i+1)),n-=r,i+=2;return n}function h(e){var t,a,r,n,i=e.e,s=e.M,h=1e-8,c=0,u=1.9,p=!1,d=0;if(!s)return 0;if(1>i&&((s<-Math.PI||s>Math.PI)&&(n=j.normalize0(s),c=s-n,s=n),.9>i)){t=Math.atan2(Math.sin(s),Math.cos(s)-i);do a=(t-i*Math.sin(t)-s)/(1-i*Math.cos(t)),t-=a;while(Math.abs(a)>h);return t}if(0>s&&(s=-s,p=!0),t=s,h*=Math.abs(1-i),1e-15>h&&(h=1e-15),(i>.8&&s<Math.PI/3||i>1)&&(r=s/Math.abs(1-i),r*r>6*Math.abs(1-i)&&(r=s<Math.PI?Math.pow(6*s,1/3):j.asinh(s/i)),t=r),i>1&&s>4&&(t=Math.log(s)),1>i)for(;Math.abs(u)>h;)a=d++>8?o(t,i)-s:t-i*Math.sin(t)-s,u=-a/(1-i*Math.cos(t)),t+=u;else for(;Math.abs(u)>h;)a=d++>7?-o(t,i)-s:i*j.sinh(t)-t-s,u=-a/(i*j.cosh(t)-1),t+=u;return p?c-t:c+t}function c(e){var t,a,r,n,i;1===e.e?(i=e.jd0-e.T,n=e.w0*i*.5,a=Math.pow(n+Math.sqrt(n*n+1),1/3),e.v=2*Math.atan(a-1/a)):(e.E=h(e),e.e>1?(t=e.e-j.cosh(e.E),a=j.sinh(e.E)):(t=Math.cos(e.E)-e.e,a=Math.sin(e.E)),a*=Math.sqrt(Math.abs(1-e.e*e.e)),e.v=Math.atan2(a,t)),r=e.q*(1+e.e),e.r=r/(1+e.e*Math.cos(e.v))}function u(e){e.hasOwnProperty("w")||(e.w=e.W-e.N),e.hasOwnProperty("M")||(e.M=e.L-e.W),e.e<1&&(e.M=j.normalize0(e.M)),e.P=Math.pow(Math.abs(e.a),1.5),e.T=e.jd0-e.M/Math.PI/2/e.P,1!==e.e?(e.q=e.a*(1-e.e),e.t0=e.a*Math.sqrt(Math.abs(e.a)/I)):(e.w0=3/Math.sqrt(2)/(e.q*Math.sqrt(e.q/I)),e.a=0,e.t0=0),e.am=Math.sqrt(I*e.q*(1+e.e))}function p(e){var t,a,r,n=e.v+e.w;return t=e.r*(Math.cos(e.N)*Math.cos(n)-Math.sin(e.N)*Math.sin(n)*Math.cos(e.i)),a=e.r*(Math.sin(e.N)*Math.cos(n)+Math.cos(e.N)*Math.sin(n)*Math.cos(e.i)),r=e.r*(Math.sin(n)*Math.sin(e.i)),e.x=t,e.y=a,e.z=r,{x:t,y:a,z:r}}function d(e){var t,a;return t=Math.atan2(e.y,e.x),a=Math.atan2(e.z,Math.sqrt(e.x*e.x+e.y*e.y)),e.l=j.normalize(t),e.b=a,{l:t,b:a}}function m(e){var t,a,r,n=e.getUTCFullYear(),i=e.getUTCMonth()+1,o=e.getUTCDate(),h=s(e),c=0,u=0,p=2400000.5,d=-4799,m=[31,28,31,30,31,30,31,31,30,31,30,31];return d>n?-1:1>i||i>12?-2:(2!==i||n%4!==0||n%100===0&&n%400!==0||(u=1),(1>o||o>m[i-1]+u)&&(c=-3),t=(i-14)/12,a=n+t,r=1461*(a+4800)/4+367*(i-2-12*t)/12-3*((a+4900)/100)/4+o-2432076,r+p+h)}function l(){requestAnimationFrame(function e(t){requestAnimationFrame(e),q=q||t-1e3/60;var a=Math.min(200,t-q);q=t,L.forEach(function(e){e(a/1e3,t/1e3)})})}var g=g||{};g.baseURL="images/";var E=new THREE.TextureLoader;g.params={sol:{map:"sunmap.jpg",radius:1.2,tilt:7.25,rot:1.0438},mer:{map:"mercurymap.jpg",bump:"mercurybump.jpg",radius:.3,tilt:0,rot:58.646},ven:{map:"venusmap.jpg",radius:.4,tilt:177.3,rot:4.05},ter:{map:"earthmapclouds.jpg",bump:"earthbump.jpg",radius:.4,tilt:23.45,rot:.9973},lun:{map:"moonmap.jpg",bump:"moonbump.jpg",radius:.25,tilt:1.54,rot:27.3217},mar:{map:"marsmap.jpg",bump:"marsbump.jpg",radius:.35,tilt:25.19,rot:1.026},cer:{map:"ceresmap.jpg",radius:.15,tilt:4,rot:.378},ves:{map:"vestamap.jpg",bump:"vestabump.jpg",radius:.15,tilt:29,rot:.223},jup:{map:"jupitermap.jpg",radius:1.2,tilt:3.12,rot:.414,ring:{map:"jupiterrings.gif",radius:2.7,opacity:.5}},sat:{map:"saturnmap.jpg",radius:1.2,tilt:26.73,rot:.444,ring:{map:"saturnrings.gif",radius:2.6,opacity:.9}},ura:{map:"uranusmap.jpg",radius:1,tilt:97.86,rot:.718,ring:{map:"uranusrings.gif",radius:2.1,opacity:.6}},nep:{map:"neptunemap.jpg",radius:1,tilt:29.56,rot:.671,ring:{map:"neptunerings.gif",radius:2.5,opacity:.8}},plu:{map:"plutomap.jpg",radius:.2,tilt:122.53,rot:6.387}},g.create=function(e,t){if(!g.params.hasOwnProperty(e))return console.log("Object not found: "+e),null;var a=t||g.params[e],r={},n=new THREE.SphereGeometry(a.radius/10,32,32);r.map=E.load(g.baseURL+a.map),a.hasOwnProperty("bump")&&(r.bumpMap=E.load(g.baseURL+a.bump),r.bumpScale=.05),a.hasOwnProperty("spec")&&(r.specularMap=E.load(g.baseURL+a.spec),r.specular=new THREE.Color("grey"));var i=new THREE.MeshPhongMaterial(r),s=new THREE.Mesh(n,i);if(a.hasOwnProperty("ring")){s.receiveShadow=!0,s.castShadow=!0;var o=g.createRing(e);o.receiveShadow=!0,o.castShadow=!0,s.add(o)}return s.rotation.set(0,0,a.tilt*H),s},g.createRing=function(e){var t=g.params[e],a=g.baseURL+t.ring.map,r=document.createElement("canvas");r.width=1024,r.height=64;var n=r.getContext("2d"),i=new Image;i.addEventListener("load",function(){var e=document.createElement("canvas");e.width=i.width,e.height=i.height;var t=e.getContext("2d");t.drawImage(i,0,0);var s=t.getImageData(0,0,e.width,e.height),h=new Image;h.addEventListener("load",function(){var e=document.createElement("canvas");e.width=h.width,e.height=h.height;var a=e.getContext("2d");a.drawImage(h,0,0);for(var c=a.getImageData(0,0,e.width,e.height),u=t.createImageData(r.width,r.height),p=0,d=0;p<i.height;p++)for(var m=0;m<i.width;m++,d+=4)u.data[d+0]=s.data[d+0],u.data[d+1]=s.data[d+1],u.data[d+2]=s.data[d+2],u.data[d+3]=c.data[d+0];n.putImageData(u,0,0),o.map.needsUpdate=!0}),h.src=a},!1),i.src=a;var s=new g._RingGeometry(t.radius/10+.005,t.ring.radius/10,64),o=new THREE.MeshPhongMaterial({map:new THREE.Texture(r),side:THREE.DoubleSide,transparent:!0,opacity:t.ring.opacity}),h=new THREE.Mesh(s,o);return h.lookAt(new THREE.Vector3(0,1,0)),h},g.createEarthCloud=function(){var e=document.createElement("canvas");e.width=1024,e.height=512;var t=e.getContext("2d"),a=new Image;a.addEventListener("load",function(){var e=document.createElement("canvas");e.width=a.width,e.height=a.height;var r=e.getContext("2d");r.drawImage(a,0,0);var i=r.getImageData(0,0,e.width,e.height),s=new Image;s.addEventListener("load",function(){var o=document.createElement("canvas");o.width=s.width,o.height=s.height;var h=o.getContext("2d");h.drawImage(s,0,0);for(var c=h.getImageData(0,0,o.width,o.height),u=r.createImageData(e.width,e.height),p=0,d=0;p<a.height;p++)for(var m=0;m<a.width;m++,d+=4)u.data[d+0]=i.data[d+0],u.data[d+1]=i.data[d+1],u.data[d+2]=i.data[d+2],u.data[d+3]=255-c.data[d+0];t.putImageData(u,0,0),n.map.needsUpdate=!0}),s.src=g.baseURL+"earthcloudmaptrans.jpg"},!1),a.src=g.baseURL+"earthcloudmap.jpg";var r=new THREE.SphereGeometry(g.params.earth.radius/10+5e-4,32,32),n=new THREE.MeshPhongMaterial({map:new THREE.Texture(e),side:THREE.DoubleSide,transparent:!0,opacity:.9}),i=new THREE.Mesh(r,n);return i},g._RingGeometry=function(e,t,a){THREE.Geometry.call(this),e=e||0,t=t||50,a=a||8;for(var r=new THREE.Vector3(0,0,1),n=0;a>n;n++){var i=n/a*Math.PI*2,s=(n+1)/a*Math.PI*2,o=new THREE.Vector3(e*Math.cos(i),e*Math.sin(i),0),h=new THREE.Vector3(t*Math.cos(i),t*Math.sin(i),0),c=new THREE.Vector3(e*Math.cos(s),e*Math.sin(s),0),u=new THREE.Vector3(t*Math.cos(s),t*Math.sin(s),0);this.vertices.push(o),this.vertices.push(h),this.vertices.push(c),this.vertices.push(u);var p=4*n,d=new THREE.Face3(p+0,p+1,p+2,r),m=[],l=new THREE.Vector2(0,0);m.push(l),l=new THREE.Vector2(1,0),m.push(l),l=new THREE.Vector2(0,1),m.push(l),this.faces.push(d),this.faceVertexUvs[0].push(m),d=new THREE.Face3(p+2,p+1,p+3,r),m=[],l=new THREE.Vector2(0,1),m.push(l),l=new THREE.Vector2(1,0),m.push(l),l=new THREE.Vector2(1,1),m.push(l),this.faces.push(d),this.faceVertexUvs[0].push(m)}this.computeFaceNormals(),this.boundingSphere=new THREE.Sphere(new THREE.Vector3,t)},g._RingGeometry.prototype=Object.create(THREE.Geometry.prototype);var w,M,f,v,y,R,T,b,H=Math.PI/180,j={sinh:function(e){return(Math.pow(Math.E,e)-Math.pow(Math.E,-e))/2},cosh:function(e){return(Math.pow(Math.E,e)+Math.pow(Math.E,-e))/2},tanh:function(e){return 2/(1+Math.exp(-2*e))-1},asinh:function(e){return Math.log(e+Math.sqrt(e*e+1))},acosh:function(e){return Math.log(e+Math.sqrt(e*e-1))},normalize0:function(e){return(e+3*Math.PI)%(2*Math.PI)-Math.PI},normalize:function(e){return(e+2*Math.PI)%(2*Math.PI)},cartesian:function(e){var t=e[0]*H,a=e[1]*H,r=e[2];return[r*Math.sin(a)*Math.cos(t),r*Math.sin(a)*Math.sin(t),r*Math.cos(a)]},spherical:function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z),a=Math.atan(e.y/e.x),r=Math.acos(e.z/t);return[a/H,r/H,t]}},I=Math.pow(.01720209895,2),P=function(e,t,n){var i,s,o,h={},l=["a","e","i","w","M","L","W","N","n"];for(n&&(I=n),t&&(i=t instanceof Date?t:r(t)),i||(i=new Date),h.jd=m(i),i=r(e.ep),h.jd0=m(i),h.d=h.jd-h.jd0,h.cy=h.d/36525,s=0;s<l.length;s++)o=l[s],a(e,"d"+o)?h[o]=e[o]+e["d"+o]*h.cy:a(e,o)&&(h[o]=e[o]),a(h,o)&&(-1===o.search(/a|e/)?h[o]*=Math.PI/180:h[o]*=1);return a(h,"M")&&!a(h,"dM")&&a(h,"n")&&(h.M+=h.n*h.d),u(h),c(h),p(h),d(h),h},x=function(e,t){var r=z(e,t.elements);if(!a(t.elements[r],"d")){var n=t.elements[r],i=P(n,e),s={name:t.name,pos:[-i.y,i.z,-i.x],elements:t.elements};return t.H&&""!==t.H?s.r=13-t.H:t.r&&""!==t.r?s.r=t.r:s.r=20,t.icon&&""!==t.icon&&(s.icon=t.icon),s}},z=function(e,t){var a=0;if(t.length>1)for(var r=0;r<t.length;r++)if(i(new Date(Date.parse(t[r].ep)),e)<=0){a=0===r?0:r-1;break}return a},D=function(e,t){for(var a,r,s=t.elements[0],o=P(s,e),h=new THREE.Geometry,c=o.P,u=n(e,c,"y"),p=i(e,u)/90,d=new Date(e.valueOf());i(d,u)>0;)r=P(s,d),h.vertices.push(new THREE.Vector3(-r.y,r.z,-r.x)),a=r.z>=0?10066329:6710886,h.colors.push(new THREE.Color(a)),d=n(d,p);return h},C={width:0,height:0,container:"map",datapath:"data/",imagepath:"img/",planets:{show:!0,image:!0,trajectory:!0,size:null},sbos:{show:!0,image:!1,text:!0,trajectory:!1,size:null},spacecraft:{show:!1,image:!1,text:!0,trajectory:!1,size:null},other:[],set:function(e){var t,r={};if(!e)return this;for(var n in this)if(a(this,n)&&"function"!=typeof this[n])if(a(e,n)&&null!==e[n])if(null===this[n]||this[n].constructor!=Object)r[n]=e[n];else{r[n]={};for(t in this[n])a(e[n],t)?r[n][t]=e[n][t]:r[n][t]=this[n][t]}else r[n]=this[n];return r}},S={version:"0.4"},L=[],V=function(r,n){var i=n||new Date,s=null;if(b=C.set(r),M=e(b.container)){s="#"+b.container;var o=window.getComputedStyle(M,null);parseInt(o.width)||b.width||(M.style.width=t(window.innerWidth)),parseInt(o.height)||b.height||(M.style.height=t(window.innerHeight))}else s="body",M=document.body;R=M?M.clientWidth:window.innerWidth,T=M?M.clientHeight:window.innerHeight,f=new THREE.WebGLRenderer({antialias:!0}),f.setClearColor("#000"),f.setSize(R,T),M.appendChild(f.domElement),v=new THREE.Scene,v.fog=new THREE.FogExp2(0,25e-5),y=new THREE.PerspectiveCamera(45,R/T,.01,1e4),y.position.z=3.5,y.position.y=2;var h=(new THREE.OrbitControls(y),new THREE.AmbientLight(16777215));v.add(h),w=d3.select(s).append("container");var c=g.create("sol");v.add(c);var u=new THREE.SpriteMaterial({map:E.load("images/corona.jpg"),useScreenCoordinates:!1,color:16777011,transparent:!1,blending:THREE.AdditiveBlending}),p=new THREE.Sprite(u);p.scale.multiplyScalar(.4),c.add(p),d3.json("data/planets.json",function(e,t){if(e)return console.log(e);for(var r in t)if(a(t,r)){var n={},s=x(i,t[r]);if(n.body=s,a(t[r],"trajectory")){var o=D(i,t[r]),h=new THREE.LineBasicMaterial({color:16777215,vertexColors:THREE.VertexColors,transparent:!0,opacity:.6,fog:!0}),c=new THREE.Line(o,h);v.add(c),n.track=c}var u=g.create(r);u||(u=new THREE.Mesh(new THREE.SphereGeometry(.02,32,32),new THREE.MeshPhongMaterial({color:"#fff"}))),u.position.fromArray(s.pos),v.add(u),n.mesh=u}}),d3.json("data/sbo.json",function(e,t){if(e)return console.log(e);for(var r=E.load("images/ast.png"),n=[],s=[],o=.006,h=1;12>=h;h++)s.push(new THREE.Geometry),n.push(new THREE.PointsMaterial({color:16777215,map:r,blending:THREE.AdditiveBlending,size:o*h,transparent:!0,fog:!0}));for(var c in t)if(a(t,c)){var u=x(i,t[c]),p=new THREE.Vector3;p.fromArray(u.pos);var d=Math.floor(u.r);d>12&&(d=12),s[d-1].vertices.push(p)}for(h=0;12>h;h++)v.add(new THREE.Points(s[h],n[h]))}),L.push(function(){var e=y.position;v.fog.density=.05/Math.pow(e.x*e.x+e.y*e.y+e.z*e.z,.5),f.render(v,y)}),l()};window.addEventListener("resize",function(){f.setSize(R,T),y.aspect=R/T,y.updateProjectionMatrix()},!1);var q=null;S.display=V,this.Orrery=S}();