// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t,a){return null!==t&&hasOwnProperty.call(t,a)}function a(t){if(t){var a=t.split(".");if(!(a.length<1)&&(a=a[0].split("-"),a[0]=a[0].replace(/\D/g,""),a[0]))return a[1]=a[1]?a[1].replace(/\D/g,""):"1",a[2]=a[2]?a[2].replace(/\D/g,""):"1",new Date(a[0],a[1]-1,a[2])}}function e(t,a,e){var n,r=t.valueOf();if(!a)return new Date(r);switch(n=e||"d"){case"y":case"yr":r+=31556926080*a;break;case"m":case"mo":r+=26298e5*a;break;case"d":case"dy":r+=864e5*a;break;case"h":case"hr":r+=36e5*a;break;case"n":case"mn":r+=6e4*a;break;case"s":case"sec":r+=1e3*a;break;case"ms":r+=a}return new Date(r)}function n(t,a,e){var n,r;if(a&&t){switch(n=a.valueOf()-t.valueOf(),r=e||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3;break;case"ms":}return n}}function r(t){return(t.getHours()+t.getTimezoneOffset()/60+t.getMinutes()/60+t.getSeconds()/3600)/24}function s(t,a){for(var e=a>1?t*t:-t*t,n=a*e*t/6,r=(1-a)*t-n,s=4;Math.abs(n)>1e-15;)n*=e/(s*(s+1)),r-=n,s+=2;return r}function o(t){var a,e,n,r,o=t.e,i=t.M,h=1e-8,c=0,u=1.9,f=!1,M=0;if(!i)return 0;if(1>o&&((i<-Math.PI||i>Math.PI)&&(r=I.normalize0(i),c=i-r,i=r),.9>o)){a=Math.atan2(Math.sin(i),Math.cos(i)-o);do e=(a-o*Math.sin(a)-i)/(1-o*Math.cos(a)),a-=e;while(Math.abs(e)>h);return a}if(0>i&&(i=-i,f=!0),a=i,h*=Math.abs(1-o),1e-15>h&&(h=1e-15),(o>.8&&i<Math.PI/3||o>1)&&(n=i/Math.abs(1-o),n*n>6*Math.abs(1-o)&&(n=i<Math.PI?Math.pow(6*i,1/3):I.asinh(i/o)),a=n),o>1&&i>4&&(a=Math.log(i)),1>o)for(;Math.abs(u)>h;)e=M++>8?s(a,o)-i:a-o*Math.sin(a)-i,u=-e/(1-o*Math.cos(a)),a+=u;else for(;Math.abs(u)>h;)e=M++>7?-s(a,o)-i:o*I.sinh(a)-a-i,u=-e/(o*I.cosh(a)-1),a+=u;return f?c-a:c+a}function i(t){var a,e,n,r,s;1===t.e?(s=t.jd0-t.T,r=t.w0*s*.5,e=Math.pow(r+Math.sqrt(r*r+1),1/3),t.v=2*Math.atan(e-1/e)):(t.E=o(t),t.e>1?(a=t.e-I.cosh(t.E),e=I.sinh(t.E)):(a=Math.cos(t.E)-t.e,e=Math.sin(t.E)),e*=Math.sqrt(Math.abs(1-t.e*t.e)),t.v=Math.atan2(e,a)),n=t.q*(1+t.e),t.r=n/(1+t.e*Math.cos(t.v))}function h(t){t.hasOwnProperty("w")||(t.w=t.W-t.N),t.hasOwnProperty("M")||(t.M=t.L-t.W),t.e<1&&(t.M=I.normalize0(t.M)),t.P=Math.pow(Math.abs(t.a),1.5),t.T=t.jd0-t.M/Math.PI/2/t.P,1!==t.e?(t.q=t.a*(1-t.e),t.t0=t.a*Math.sqrt(Math.abs(t.a)/x)):(t.w0=3/Math.sqrt(2)/(t.q*Math.sqrt(t.q/x)),t.a=0,t.t0=0),t.am=Math.sqrt(x*t.q*(1+t.e))}function c(t){var a,e,n,r=t.v+t.w;return a=t.r*(Math.cos(t.N)*Math.cos(r)-Math.sin(t.N)*Math.sin(r)*Math.cos(t.i)),e=t.r*(Math.sin(t.N)*Math.cos(r)+Math.cos(t.N)*Math.sin(r)*Math.cos(t.i)),n=t.r*(Math.sin(r)*Math.sin(t.i)),t.x=a,t.y=e,t.z=n,{x:a,y:e,z:n}}function u(t){var a,e,n,s=t.getUTCFullYear(),o=t.getUTCMonth()+1,i=t.getUTCDate(),h=r(t),c=0,u=0,f=2400000.5,M=-4799,l=[31,28,31,30,31,30,31,31,30,31,30,31];return M>s?-1:1>o||o>12?-2:(2!==o||s%4!==0||s%100===0&&s%400!==0||(u=1),(1>i||i>l[o-1]+u)&&(c=-3),a=(o-14)/12,e=s+a,n=1461*(e+4800)/4+367*(o-2-12*a)/12-3*((e+4900)/100)/4+i-2432076,n+f+h)}function f(){U=S?S.clientWidth:window.innerWidth,L=S?S.clientHeight:window.innerHeight,J.attr("width",U).attr("height",L),K.attr("transform","translate("+U/2+","+L/2+")"),d()}function M(t){var a=[];return t.forEach(function(t){for(var e=[],n=0;n<t.length;n++){var r=y(F,t[n]);r[0]*=C,r[2]*=C,e.push([r[0],-r[2]])}a.push(e)}),a}function l(t){var a=y(F,t.pos),e=t.r/2,n="Saturn"==t.name?1.35*t.r:e;return a[0]*=C,a[2]*=C,e&&(a[0]-=n,a[2]+=e),"translate("+a[0]+","+-a[2]+")"}function d(){if(C=G.scale(),"wheel"!==d3.event.sourceEvent.type){var t=G.translate();A=[30-B(t[1]),0,90+Y(t[0])],F=k(A)}Q=Math.pow(C,.8),g.attr({x:-Q/2,y:-Q/2,width:Q,height:Q}),w.attr("transform",l),p=M(W),v.data(p).attr("d",R),b.attr("transform",l)}var p,g,w,v,m,b,y=function(t,a){for(var e=[],n=0;3>n;n++){for(var r=0,s=0;3>s;s++)r+=t[n][s]*a[s];e[n]=r}return e},P=function(t,a){for(var e=[],n=0;3>n;n++){e[n]=[];for(var r=0;3>r;r++){for(var s=0,o=0;3>o;o++)s+=a[n][o]*t[o][r];e[n][r]=s}}return e},k=function(t){return P(z("z",t[2]),z("x",t[0]))},z=function(t,a){var e=-a*Math.PI/180,n=Math.cos(e),r=Math.sin(e);switch(t){case"x":return[[1,0,0],[0,n,r],[0,-r,n]];case"y":return[[n,0,-r],[0,1,0],[r,0,n]];case"z":return[[n,r,0],[-r,n,0],[0,0,1]]}},I={sinh:function(t){return(Math.pow(Math.E,t)-Math.pow(Math.E,-t))/2},cosh:function(t){return(Math.pow(Math.E,t)+Math.pow(Math.E,-t))/2},tanh:function(t){return 2/(1+Math.exp(-2*t))-1},asinh:function(t){return Math.log(t+Math.sqrt(t*t+1))},acosh:function(t){return Math.log(t+Math.sqrt(t*t-1))},normalize0:function(t){return(t+3*Math.PI)%(2*Math.PI)-Math.PI},normalize:function(t){return(t+2*Math.PI)%(2*Math.PI)},deg2rad:function(t){return t*Math.PI/180},hour2rad:function(t){return t*Math.PI/12},rad2deg:function(t){return 180*t/Math.PI},rad2hour:function(t){return 12*t/Math.PI}},x=Math.pow(.01720209895,2),j=function(e,n,r){var s,o,f,M={},l=["a","e","i","w","M","L","W","N","n"];for(r&&(x=r),n&&(s=n instanceof Date?n:a(n)),s||(s=new Date),M.jd=u(s),s=a(e.ep),M.jd0=u(s),M.d=M.jd-M.jd0,M.cy=M.d/36525,o=0;o<l.length;o++)f=l[o],t(e,"d"+f)?M[f]=e[f]+e["d"+f]*M.cy:t(e,f)&&(M[f]=e[f]),t(M,f)&&(-1===f.search(/a|e/)?M[f]*=Math.PI/180:M[f]*=1);return t(M,"M")&&!t(M,"dM")&&t(M,"n")&&(M.M+=M.n*M.d),h(M),i(M),c(M),M},q=function(t){if(!(t.elements.length>1)){var a=t.elements[0],e=j(a,T),n={name:t.name,pos:[e.x,e.y,e.z],r:12-t.H};return t.icon&&""!==t.icon&&(n.icon=t.icon),n}},E=function(t){for(var a,r=t.elements[0],s=[],o=j(r,T),i=o.P,h=e(T,i,"y"),c=n(T,h)/90/o.a,u=new Date(T.valueOf());n(u,h)>0;)a=j(r,u),s.push([a.x,a.y,a.z]),u=e(u,c);return s.push([o.x,o.y,o.z]),s},D={version:"0.2",svg:null},O=[],H=[],W=[],N=[],T=new Date,A=[30,0,90],C=60,S=null,U=S?S.clientWidth:window.innerWidth,L=S?S.clientHeight:window.innerHeight,F=k(A),Y=d3.scale.linear().domain([-U/2,U/2]).range([-360,360]),B=d3.scale.linear().domain([-L/2,L/2]).range([90,-90]).clamp(!0),G=d3.behavior.zoom().center([0,0]).scaleExtent([10,150]).scale(C).on("zoom",d),J=d3.select("body").append("svg").attr("width",U).attr("height",L).call(G),K=J.append("g").attr("transform","translate("+U/2+","+L/2+")"),Q=Math.pow(C,.8);g=K.append("image").attr({"xlink:href":"img/sun.png",x:-Q/2,y:-Q/2,width:Q,height:Q});var R=d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]});d3.json("data/planets.json",function(a,e){if(a)return console.log(a);for(var n in e)t(e,n)&&(O.push(q(e[n])),t(e[n],"trajectory")&&e[n].trajectory===!0&&W.push(E(e[n])));p=M(W),v=K.selectAll(".tracks").data(p).enter().append("path").attr("class","dot").attr("d",R),w=K.selectAll(".planets").data(O).enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",l).attr("class","planet").attr("width",function(t){return"Saturn"==t.name?2.7*t.r:t.r}).attr("height",function(t){return t.r})}),d3.json("data/sbo.json",function(a,e){if(a)return console.log(a);for(var n in e)t(e,n)&&e[n].H<11&&H.push(q(e[n]));b=K.selectAll(".sbos").data(H).enter().append("path").attr("transform",l).attr("class","sbo").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),d3.json("data/probes.json",function(a,e){if(a)return console.log(a);for(var n in e)if(t(e,n)){var r=q(e[n]);r&&N.push(r)}m=K.selectAll(".probes").data(N).enter().append("image").attr("xlink:href",function(t){return"../../blog/res/probes/"+t.icon}).attr("transform",l).attr("class","planet").attr("width",20).attr("height",20)}),d3.select(window).on("resize",f),this.Orrery=D}();