// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t,a){return null!==t&&hasOwnProperty.call(t,a)}function a(t){if(t){var a=t.split(".");if(!(a.length<1)&&(a=a[0].split("-"),a[0]=a[0].replace(/\D/g,""),a[0]))return a[1]=a[1]?a[1].replace(/\D/g,""):"1",a[2]=a[2]?a[2].replace(/\D/g,""):"1",new Date(a[0],a[1]-1,a[2])}}function e(t,a,e){var n,r=t.valueOf();if(!a)return new Date(r);switch(n=e||"d"){case"y":case"yr":r+=31556926080*a;break;case"m":case"mo":r+=26298e5*a;break;case"d":case"dy":r+=864e5*a;break;case"h":case"hr":r+=36e5*a;break;case"n":case"mn":r+=6e4*a;break;case"s":case"sec":r+=1e3*a;break;case"ms":r+=a}return new Date(r)}function n(t,a,e){var n,r;if(a&&t){switch(n=a.valueOf()-t.valueOf(),r=e||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3;break;case"ms":}return n}}function r(t){return(t.getHours()+t.getTimezoneOffset()/60+t.getMinutes()/60+t.getSeconds()/3600)/24}function s(t,a){for(var e=a>1?t*t:-t*t,n=a*e*t/6,r=(1-a)*t-n,s=4;Math.abs(n)>1e-15;)n*=e/(s*(s+1)),r-=n,s+=2;return r}function o(t){var a,e,n,r,o=t.e,h=t.M,i=1e-8,c=0,u=1.9,M=!1,f=0;if(!h)return 0;if(1>o&&((h<-Math.PI||h>Math.PI)&&(r=x.normalize0(h),c=h-r,h=r),.9>o)){a=Math.atan2(Math.sin(h),Math.cos(h)-o);do e=(a-o*Math.sin(a)-h)/(1-o*Math.cos(a)),a-=e;while(Math.abs(e)>i);return a}if(0>h&&(h=-h,M=!0),a=h,i*=Math.abs(1-o),1e-15>i&&(i=1e-15),(o>.8&&h<Math.PI/3||o>1)&&(n=h/Math.abs(1-o),n*n>6*Math.abs(1-o)&&(n=h<Math.PI?Math.pow(6*h,1/3):x.asinh(h/o)),a=n),o>1&&h>4&&(a=Math.log(h)),1>o)for(;Math.abs(u)>i;)e=f++>8?s(a,o)-h:a-o*Math.sin(a)-h,u=-e/(1-o*Math.cos(a)),a+=u;else for(;Math.abs(u)>i;)e=f++>7?-s(a,o)-h:o*x.sinh(a)-a-h,u=-e/(o*x.cosh(a)-1),a+=u;return M?c-a:c+a}function h(t){var a,e,n,r,s;1===t.e?(s=t.jd0-t.T,r=t.w0*s*.5,e=Math.pow(r+Math.sqrt(r*r+1),1/3),t.v=2*Math.atan(e-1/e)):(t.E=o(t),t.e>1?(a=t.e-x.cosh(t.E),e=x.sinh(t.E)):(a=Math.cos(t.E)-t.e,e=Math.sin(t.E)),e*=Math.sqrt(Math.abs(1-t.e*t.e)),t.v=Math.atan2(e,a)),n=t.q*(1+t.e),t.r=n/(1+t.e*Math.cos(t.v))}function i(t){t.hasOwnProperty("w")||(t.w=t.W-t.N),t.hasOwnProperty("M")||(t.M=t.L-t.W),t.e<1&&(t.M=x.normalize0(t.M)),t.P=Math.pow(Math.abs(t.a),1.5),t.T=t.jd0-t.M/Math.PI/2/t.P,1!==t.e?(t.q=t.a*(1-t.e),t.t0=t.a*Math.sqrt(Math.abs(t.a)/I)):(t.w0=3/Math.sqrt(2)/(t.q*Math.sqrt(t.q/I)),t.a=0,t.t0=0),t.am=Math.sqrt(I*t.q*(1+t.e))}function c(t){var a,e,n,r=t.v+t.w;return a=t.r*(Math.cos(t.N)*Math.cos(r)-Math.sin(t.N)*Math.sin(r)*Math.cos(t.i)),e=t.r*(Math.sin(t.N)*Math.cos(r)+Math.cos(t.N)*Math.sin(r)*Math.cos(t.i)),n=t.r*(Math.sin(r)*Math.sin(t.i)),t.x=a,t.y=e,t.z=n,{x:a,y:e,z:n}}function u(t){var a,e,n,s=t.getUTCFullYear(),o=t.getUTCMonth()+1,h=t.getUTCDate(),i=r(t),c=0,u=0,M=2400000.5,f=-4799,l=[31,28,31,30,31,30,31,31,30,31,30,31];return f>s?-1:1>o||o>12?-2:(2!==o||s%4!==0||s%100===0&&s%400!==0||(u=1),(1>h||h>l[o-1]+u)&&(c=-3),a=(o-14)/12,e=s+a,n=1461*(e+4800)/4+367*(o-2-12*a)/12-3*((e+4900)/100)/4+h-2432076,n+M+i)}function M(t){var a=[];return t.forEach(function(t){for(var e=[],n=0;n<t.length;n++){var r=b(L,t[n]);r[0]*=A,r[2]*=A,e.push([r[0],-r[2]])}a.push(e)}),a}function f(t){var a=b(L,t.pos),e=t.r/2,n="Saturn"==t.name?1.35*t.r:e;return a[0]*=A,a[2]*=A,e&&(a[0]-=n,a[2]+=e),"translate("+a[0]+","+-a[2]+")"}function l(){if(A=B.scale(),"wheel"!==d3.event.sourceEvent.type){var t=B.translate();W=[30-Y(t[1]),0,90+F(t[0])],L=P(W)}K=Math.pow(A,.8),p.attr({"xlink:href":"../../blog/res/planets/sun.png",x:-K/2,y:-K/2,width:K,height:K}),g.attr("transform",f),d=M(N),v.data(d).attr("d",Q),m.attr("transform",f)}var d,p,g,v,w,m,b=function(t,a){for(var e=[],n=0;3>n;n++){for(var r=0,s=0;3>s;s++)r+=t[n][s]*a[s];e[n]=r}return e},y=function(t,a){for(var e=[],n=0;3>n;n++){e[n]=[];for(var r=0;3>r;r++){for(var s=0,o=0;3>o;o++)s+=a[n][o]*t[o][r];e[n][r]=s}}return e},P=function(t){return y(k("z",t[2]),k("x",t[0]))},k=function(t,a){var e=-a*Math.PI/180,n=Math.cos(e),r=Math.sin(e);switch(t){case"x":return[[1,0,0],[0,n,r],[0,-r,n]];case"y":return[[n,0,-r],[0,1,0],[r,0,n]];case"z":return[[n,r,0],[-r,n,0],[0,0,1]]}},x={sinh:function(t){return(Math.pow(Math.E,t)-Math.pow(Math.E,-t))/2},cosh:function(t){return(Math.pow(Math.E,t)+Math.pow(Math.E,-t))/2},tanh:function(t){return 2/(1+Math.exp(-2*t))-1},asinh:function(t){return Math.log(t+Math.sqrt(t*t+1))},acosh:function(t){return Math.log(t+Math.sqrt(t*t-1))},normalize0:function(t){return(t+3*Math.PI)%(2*Math.PI)-Math.PI},normalize:function(t){return(t+2*Math.PI)%(2*Math.PI)},deg2rad:function(t){return t*Math.PI/180},hour2rad:function(t){return t*Math.PI/12},rad2deg:function(t){return 180*t/Math.PI},rad2hour:function(t){return 12*t/Math.PI}},I=Math.pow(.01720209895,2),z=function(e,n,r){var s,o,M,f={},l=["a","e","i","w","M","L","W","N","n"];for(r&&(I=r),n&&(s=n instanceof Date?n:a(n)),s||(s=new Date),f.jd=u(s),s=a(e.ep),f.jd0=u(s),f.d=f.jd-f.jd0,f.cy=f.d/36525,o=0;o<l.length;o++)M=l[o],t(e,"d"+M)?f[M]=e[M]+e["d"+M]*f.cy:t(e,M)&&(f[M]=e[M]),t(f,M)&&(-1===M.search(/a|e/)?f[M]*=Math.PI/180:f[M]*=1);return t(f,"M")&&!t(f,"dM")&&t(f,"n")&&(f.M+=f.n*f.d),i(f),h(f),c(f),f},q=function(t){if(!(t.elements.length>1)){var a=t.elements[0],e=z(a,H),n={name:t.name,pos:[e.x,e.y,e.z],r:12-t.H};return t.icon&&""!==t.icon&&(n.icon=t.icon),n}},j=function(t){for(var a,r=t.elements[0],s=[],o=z(r,H),h=o.P,i=e(H,h,"y"),c=n(H,i)/90/o.a,u=new Date(H.valueOf());n(u,i)>0;)a=z(r,u),s.push([a.x,a.y,a.z]),u=e(u,c);return s.push([o.x,o.y,o.z]),s},E={version:"0.2",svg:null},D=[],O=[],N=[],T=[],H=new Date,W=[30,0,90],A=60,C=null,S=C?C.clientWidth:window.innerWidth,U=C?C.clientHeight:window.innerHeight,L=P(W),F=d3.scale.linear().domain([-S/2,S/2]).range([-360,360]),Y=d3.scale.linear().domain([-U/2,U/2]).range([90,-90]).clamp(!0),B=d3.behavior.zoom().center([0,0]).scaleExtent([10,150]).scale(A).on("zoom",l),G=d3.select("body").append("svg").attr("width",S).attr("height",U).call(B),J=G.append("g").attr("transform","translate("+S/2+","+U/2+")"),K=Math.pow(A,.8);p=J.append("image").attr({"xlink:href":"img/sun.png",x:-K/2,y:-K/2,width:K,height:K});var Q=d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]});d3.json("data/planets.json",function(a,e){if(a)return console.log(a);for(var n in e)t(e,n)&&(D.push(q(e[n])),N.push(j(e[n])));d=M(N),v=J.selectAll(".tracks").data(d).enter().append("path").attr("class","dot").attr("d",Q),g=J.selectAll(".planets").data(D).enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",f).attr("class","planet").attr("width",function(t){return"Saturn"==t.name?2.7*t.r:t.r}).attr("height",function(t){return t.r})}),d3.json("data/sbo.json",function(a,e){if(a)return console.log(a);for(var n in e)t(e,n)&&e[n].H<11&&O.push(q(e[n]));m=J.selectAll(".sbos").data(O).enter().append("path").attr("transform",f).attr("class","sbo").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),d3.json("data/probes.json",function(a,e){if(a)return console.log(a);for(var n in e)if(t(e,n)){var r=q(e[n]);r&&T.push(r)}w=J.selectAll(".probes").data(T).enter().append("image").attr("xlink:href",function(t){return"../../blog/res/probes/"+t.icon}).attr("transform",f).attr("class","planet").attr("width",20).attr("height",20)}),this.Orrery=E}();