// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t,a){return null!==t&&hasOwnProperty.call(t,a)}function a(t){if(t){var a=t.split(".");if(!(a.length<1)&&(a=a[0].split("-"),a[0]=a[0].replace(/\D/g,""),a[0]))return a[1]=a[1]?a[1].replace(/\D/g,""):"1",a[2]=a[2]?a[2].replace(/\D/g,""):"1",new Date(a[0],a[1]-1,a[2])}}function e(t,a,e){var n,r=t.valueOf();if(!a)return new Date(r);switch(n=e||"d"){case"y":case"yr":r+=31556926080*a;break;case"m":case"mo":r+=26298e5*a;break;case"d":case"dy":r+=864e5*a;break;case"h":case"hr":r+=36e5*a;break;case"n":case"mn":r+=6e4*a;break;case"s":case"sec":r+=1e3*a;break;case"ms":r+=a}return new Date(r)}function n(t,a,e){var n,r;if(a&&t){switch(n=a.valueOf()-t.valueOf(),r=e||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3;break;case"ms":}return n}}function r(t){return(t.getHours()+t.getTimezoneOffset()/60+t.getMinutes()/60+t.getSeconds()/3600)/24}function s(t){var a,e,n,s=t.getUTCFullYear(),o=t.getUTCMonth()+1,h=t.getUTCDate(),c=r(t),i=0,u=0,M=2400000.5,f=-4799,l=[31,28,31,30,31,30,31,31,30,31,30,31];return f>s?-1:1>o||o>12?-2:(2!==o||s%4!==0||s%100===0&&s%400!==0||(u=1),(1>h||h>l[o-1]+u)&&(i=-3),a=(o-14)/12,e=s+a,n=1461*(e+4800)/4+367*(o-2-12*a)/12-3*((e+4900)/100)/4+h-2432076,n+M+c)}function o(t){var a=[];return t.forEach(function(t){for(var e=[],n=0;n<t.length;n++){var r=d(N,t[n]);r[0]*=E,r[2]*=E,e.push([r[0],-r[2]])}a.push(e)}),a}function h(t){var a=d(N,t.pos),e=t.r/2,n="Saturn"==t.name?1.35*t.r:e;return a[0]*=E,a[2]*=E,e&&(a[0]-=n,a[2]+=e),"translate("+a[0]+","+-a[2]+")"}function c(){if(E=W.scale(),"wheel"!==d3.event.sourceEvent.type){var t=W.translate();q=[30-H(t[1]),0,90+T(t[0])],N=v(q)}S=Math.pow(E,.8),u.attr({"xlink:href":"../../blog/res/planets/sun.png",x:-S/2,y:-S/2,width:S,height:S}),M.attr("transform",h),i=o(x),f.data(i).attr("d",U),l.attr("transform",h)}var i,u,M,f,l,d=function(t,a){for(var e=[],n=0;3>n;n++){for(var r=0,s=0;3>s;s++)r+=t[n][s]*a[s];e[n]=r}return e},p=function(t,a){for(var e=[],n=0;3>n;n++){e[n]=[];for(var r=0;3>r;r++){for(var s=0,o=0;3>o;o++)s+=a[n][o]*t[o][r];e[n][r]=s}}return e},v=function(t){return p(g("z",t[2]),g("x",t[0]))},g=function(t,a){var e=-a*Math.PI/180,n=Math.cos(e),r=Math.sin(e);switch(t){case"x":return[[1,0,0],[0,n,r],[0,-r,n]];case"y":return[[n,0,-r],[0,1,0],[r,0,n]];case"z":return[[n,r,0],[-r,n,0],[0,0,1]]}},w={sinh:function(t){return(Math.pow(Math.E,t)-Math.pow(Math.E,-t))/2},cosh:function(t){return(Math.pow(Math.E,t)+Math.pow(Math.E,-t))/2},tanh:function(t){return 2/(1+Math.exp(-2*t))-1},asinh:function(t){return Math.log(t+Math.sqrt(t*t+1))},acosh:function(t){return Math.log(t+Math.sqrt(t*t-1))},normalize0:function(t){return(t+3*Math.PI)%(2*Math.PI)-Math.PI},normalize:function(t){return(t+2*Math.PI)%(2*Math.PI)},deg2rad:function(t){return t*Math.PI/180},hour2rad:function(t){return t*Math.PI/12},rad2deg:function(t){return 180*t/Math.PI},rad2hour:function(t){return 12*t/Math.PI}},m=function(e,n,r){var o,h,c,i,u={},M=["a","e","i","w","M","L","W","N"],f=function(t,a){for(var e=a>1?t*t:-t*t,n=a*e*t/6,r=(1-a)*t-n,s=4;Math.abs(n)>1e-15;)n*=e/(s*(s+1)),r-=n,s+=2;return r},l=function(t){var a,e,n,r,s=t.e,o=t.M,h=1e-8,c=0,i=1.9,u=!1,M=0;if(!o)return 0;if(1>s&&((o<-Math.PI||o>Math.PI)&&(r=w.normalize0(o),c=o-r,o=r),.9>s)){a=Math.atan2(Math.sin(o),Math.cos(o)-s);do e=(a-s*Math.sin(a)-o)/(1-s*Math.cos(a)),a-=e;while(Math.abs(e)>h);return a}if(0>o&&(o=-o,u=!0),a=o,h*=Math.abs(1-s),1e-15>h&&(h=1e-15),(s>.8&&o<Math.PI/3||s>1)&&(n=o/Math.abs(1-s),n*n>6*Math.abs(1-s)&&(n=o<Math.PI?Math.pow(6*o,1/3):w.asinh(o/s)),a=n),s>1&&o>4&&(a=Math.log(o)),1>s)for(;Math.abs(i)>h;)e=M++>8?f(a,s)-o:a-s*Math.sin(a)-o,i=-e/(1-s*Math.cos(a)),a+=i;else for(;Math.abs(i)>h;)e=M++>7?-f(a,s)-o:s*w.sinh(a)-a-o,i=-e/(s*w.cosh(a)-1),a+=i;return u?c-a:c+a},d=function(t){var a,e,n,r,s;1===t.e?(s=t.jd0-t.T,r=t.w0*s*.5,e=Math.pow(r+Math.sqrt(r*r+1),1/3),t.v=2*Math.atan(e-1/e)):(t.E=l(t),t.e>1?(a=t.e-w.cosh(t.E),e=w.sinh(t.E)):(a=Math.cos(t.E)-t.e,e=Math.sin(t.E)),e*=Math.sqrt(Math.abs(1-t.e*t.e)),t.v=Math.atan2(e,a)),n=t.q*(1+t.e),t.r=n/(1+t.e*Math.cos(t.v))},p=function(t){t.hasOwnProperty("w")||(t.w=t.W-t.N),t.hasOwnProperty("M")||(t.M=t.L-t.W),t.e<1&&(t.M=w.normalize0(t.M)),t.P=Math.pow(Math.abs(t.a),1.5),t.T=t.jd0-t.M/Math.PI/2/t.P,1!==t.e?(t.q=t.a*(1-t.e),t.t0=t.a*Math.sqrt(Math.abs(t.a)/i)):(t.w0=3/Math.sqrt(2)/(t.q*Math.sqrt(t.q/i)),t.a=0,t.t0=0),t.am=Math.sqrt(i*t.q*(1+t.e))},v=function(t){var a,e,n,r=t.v+t.w;return a=t.r*(Math.cos(t.N)*Math.cos(r)-Math.sin(t.N)*Math.sin(r)*Math.cos(t.i)),e=t.r*(Math.sin(t.N)*Math.cos(r)+Math.cos(t.N)*Math.sin(r)*Math.cos(t.i)),n=t.r*(Math.sin(r)*Math.sin(t.i)),t.x=a,t.y=e,t.z=n,{x:a,y:e,z:n}};for(i=r||Math.pow(.01720209895,2),n&&(o=n instanceof Date?n:a(n)),o||(o=new Date),u.jd=s(o),o=a(e.ep),u.jd0=s(o),u.d=u.jd-u.jd0,u.cy=u.d/36525,h=0;h<M.length;h++)c=M[h],t(e,"d"+c)?u[c]=e[c]+e["d"+c]*u.cy:t(e,c)&&(u[c]=e[c]),t(u,c)&&(-1===c.search(/a|e/)?u[c]*=Math.PI/180:u[c]*=1);return t(u,"M")&&!t(u,"dM")&&t(u,"n")&&(u.M+=u.n*(Math.PI/180)*u.d),p(u),d(u),v(u),u},b=function(t){var a=t.elements[0],e=m(a,z),n={name:t.name,pos:[e.x,e.y,e.z],r:12-t.H};return t.icon&&""!==t.icon&&(n.icon=t.icon),n},y=function(t){for(var a,r=t.elements[0],s=[],o=m(r,z),h=o.P,c=e(z,h,"y"),i=n(z,c)/90/o.a,u=new Date(z.valueOf());n(u,c)>0;)a=m(r,u),s.push([a.x,a.y,a.z]),u=e(u,i);return s.push([o.x,o.y,o.z]),s},P={version:"0.2",svg:null},I=[],k=[],x=[],z=new Date,q=[30,0,90],E=60,D=null,j=D?D.clientWidth:window.innerWidth,O=D?D.clientHeight:window.innerHeight,N=v(q),T=d3.scale.linear().domain([-j/2,j/2]).range([-360,360]),H=d3.scale.linear().domain([-O/2,O/2]).range([90,-90]).clamp(!0),W=d3.behavior.zoom().center([0,0]).scaleExtent([10,150]).scale(E).on("zoom",c),A=d3.select("body").append("svg").attr("width",j).attr("height",O).call(W),C=A.append("g").attr("transform","translate("+j/2+","+O/2+")"),S=Math.pow(E,.8);u=C.append("image").attr({"xlink:href":"img/sun.png",x:-S/2,y:-S/2,width:S,height:S});var U=d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]});d3.json("data/planets.json",function(a,e){if(a)return console.log(a);for(var n in e)t(e,n)&&(I.push(b(e[n])),x.push(y(e[n])));i=o(x),f=C.selectAll(".tracks").data(i).enter().append("path").attr("class","dot").attr("d",U),M=C.selectAll(".planets").data(I).enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",h).attr("class","planet").attr("width",function(t){return"Saturn"==t.name?2.7*t.r:t.r}).attr("height",function(t){return t.r})}),d3.json("data/sbo.json",function(a,e){if(a)return console.log(a);for(var n in e)t(e,n)&&e[n].H<11&&k.push(b(e[n]));l=C.selectAll(".sbos").data(k).enter().append("path").attr("transform",h).attr("class","sbo").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),this.Orrery=P}();