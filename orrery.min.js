// Copyright 2015 Olaf Frohn https://github.com/ofrohn, see LICENSE
!function(){function t(t){return document.getElementById(t)}function e(t){return t+"px"}function a(t,e){return null!==t&&hasOwnProperty.call(t,e)}function n(t){if(t){var e=t.split(".");if(!(e.length<1)&&(e=e[0].split("-"),e[0]=e[0].replace(/\D/g,""),e[0]))return e[1]=e[1]?e[1].replace(/\D/g,""):"1",e[2]=e[2]?e[2].replace(/\D/g,""):"1",new Date(e[0],e[1]-1,e[2])}}function r(t,e,a){var n,r=t.valueOf();if(!e)return new Date(r);switch(n=a||"d"){case"y":case"yr":r+=31556926080*e;break;case"m":case"mo":r+=26298e5*e;break;case"d":case"dy":r+=864e5*e;break;case"h":case"hr":r+=36e5*e;break;case"n":case"mn":r+=6e4*e;break;case"s":case"sec":r+=1e3*e;break;case"ms":r+=e}return new Date(r)}function s(t,e,a){var n,r;if(e&&t){switch(n=e.valueOf()-t.valueOf(),r=a||"d"){case"y":case"yr":n/=31556926080;break;case"m":case"mo":n/=26298e5;break;case"d":case"dy":n/=864e5;break;case"h":case"hr":n/=36e5;break;case"n":case"mn":n/=6e4;break;case"s":case"sec":n/=1e3;break;case"ms":}return n}}function i(t){return(t.getHours()+t.getTimezoneOffset()/60+t.getMinutes()/60+t.getSeconds()/3600)/24}function o(t,e){for(var a=e>1?t*t:-t*t,n=e*a*t/6,r=(1-e)*t-n,s=4;Math.abs(n)>1e-15;)n*=a/(s*(s+1)),r-=n,s+=2;return r}function h(t){var e,a,n,r,s=t.e,i=t.M,h=1e-8,c=0,u=1.9,l=!1,f=0;if(!i)return 0;if(1>s&&((i<-Math.PI||i>Math.PI)&&(r=A.normalize0(i),c=i-r,i=r),.9>s)){e=Math.atan2(Math.sin(i),Math.cos(i)-s);do a=(e-s*Math.sin(e)-i)/(1-s*Math.cos(e)),e-=a;while(Math.abs(a)>h);return e}if(0>i&&(i=-i,l=!0),e=i,h*=Math.abs(1-s),1e-15>h&&(h=1e-15),(s>.8&&i<Math.PI/3||s>1)&&(n=i/Math.abs(1-s),n*n>6*Math.abs(1-s)&&(n=i<Math.PI?Math.pow(6*i,1/3):A.asinh(i/s)),e=n),s>1&&i>4&&(e=Math.log(i)),1>s)for(;Math.abs(u)>h;)a=f++>8?o(e,s)-i:e-s*Math.sin(e)-i,u=-a/(1-s*Math.cos(e)),e+=u;else for(;Math.abs(u)>h;)a=f++>7?-o(e,s)-i:s*A.sinh(e)-e-i,u=-a/(s*A.cosh(e)-1),e+=u;return l?c-e:c+e}function c(t){var e,a,n,r,s;1===t.e?(s=t.jd0-t.T,r=t.w0*s*.5,a=Math.pow(r+Math.sqrt(r*r+1),1/3),t.v=2*Math.atan(a-1/a)):(t.E=h(t),t.e>1?(e=t.e-A.cosh(t.E),a=A.sinh(t.E)):(e=Math.cos(t.E)-t.e,a=Math.sin(t.E)),a*=Math.sqrt(Math.abs(1-t.e*t.e)),t.v=Math.atan2(a,e)),n=t.q*(1+t.e),t.r=n/(1+t.e*Math.cos(t.v))}function u(t){t.hasOwnProperty("w")||(t.w=t.W-t.N),t.hasOwnProperty("M")||(t.M=t.L-t.W),t.e<1&&(t.M=A.normalize0(t.M)),t.P=Math.pow(Math.abs(t.a),1.5),t.T=t.jd0-t.M/Math.PI/2/t.P,1!==t.e?(t.q=t.a*(1-t.e),t.t0=t.a*Math.sqrt(Math.abs(t.a)/C)):(t.w0=3/Math.sqrt(2)/(t.q*Math.sqrt(t.q/C)),t.a=0,t.t0=0),t.am=Math.sqrt(C*t.q*(1+t.e))}function l(t){var e,a,n,r=t.v+t.w;return e=t.r*(Math.cos(t.N)*Math.cos(r)-Math.sin(t.N)*Math.sin(r)*Math.cos(t.i)),a=t.r*(Math.sin(t.N)*Math.cos(r)+Math.cos(t.N)*Math.sin(r)*Math.cos(t.i)),n=t.r*(Math.sin(r)*Math.sin(t.i)),t.x=e,t.y=a,t.z=n,{x:e,y:a,z:n}}function f(t){var e,a,n,r=t.getUTCFullYear(),s=t.getUTCMonth()+1,o=t.getUTCDate(),h=i(t),c=0,u=0,l=2400000.5,f=-4799,d=[31,28,31,30,31,30,31,31,30,31,30,31];return f>r?-1:1>s||s>12?-2:(2!==s||r%4!==0||r%100===0&&r%400!==0||(u=1),(1>o||o>d[s-1]+u)&&(c=-3),e=(s-14)/12,a=r+e,n=1461*(a+4800)/4+367*(s-2-12*e)/12-3*((a+4900)/100)/4+o-2432076,n+l+h)}function d(){x.width&&x.width>0||(P=z?z.clientWidth:window.innerWidth,j=z?z.clientHeight:window.innerHeight,w.attr("width",P).attr("height",j),m.attr("transform","translate("+P/2+","+j/2+")"),g())}function M(t){var e=[];return t.forEach(function(t){for(var a=[],n=0;n<t.length;n++){var r=O(b,t[n]);r[0]*=J,r[2]*=J,a.push([r[0],-r[2]])}e.push(a)}),e}function p(t){var e=O(b,t.pos),a=t.r/2,n="Saturn"==t.name?1.35*t.r:a;return e[0]*=J,e[2]*=J,a&&(e[0]-=n,e[2]+=a),"translate("+e[0]+","+-e[2]+")"}function g(){if(J=Z.scale(),d3.event&&"wheel"!==d3.event.sourceEvent.type){var t=Z.translate();K=[30-v(t[1]),0,90+y(t[0])],b=N(K)}var e=Math.pow(J,.8);I.attr({x:-e/2,y:-e/2,width:e,height:e}),k.attr("transform",p),H=M(X),q.data(H).attr("d",$),E.attr("transform",p),D&&D.attr("transform",p)}var w,m,v,y,b,z,P,j,x,I,k,q,D,E,H,O=function(t,e){for(var a=[],n=0;3>n;n++){for(var r=0,s=0;3>s;s++)r+=t[n][s]*e[s];a[n]=r}return a},W=function(t,e){for(var a=[],n=0;3>n;n++){a[n]=[];for(var r=0;3>r;r++){for(var s=0,i=0;3>i;i++)s+=e[n][i]*t[i][r];a[n][r]=s}}return a},N=function(t){return W(T("z",t[2]),T("x",t[0]))},T=function(t,e){var a=-e*Math.PI/180,n=Math.cos(a),r=Math.sin(a);switch(t){case"x":return[[1,0,0],[0,n,r],[0,-r,n]];case"y":return[[n,0,-r],[0,1,0],[r,0,n]];case"z":return[[n,r,0],[-r,n,0],[0,0,1]]}},A={sinh:function(t){return(Math.pow(Math.E,t)-Math.pow(Math.E,-t))/2},cosh:function(t){return(Math.pow(Math.E,t)+Math.pow(Math.E,-t))/2},tanh:function(t){return 2/(1+Math.exp(-2*t))-1},asinh:function(t){return Math.log(t+Math.sqrt(t*t+1))},acosh:function(t){return Math.log(t+Math.sqrt(t*t-1))},normalize0:function(t){return(t+3*Math.PI)%(2*Math.PI)-Math.PI},normalize:function(t){return(t+2*Math.PI)%(2*Math.PI)},deg2rad:function(t){return t*Math.PI/180},hour2rad:function(t){return t*Math.PI/12},rad2deg:function(t){return 180*t/Math.PI},rad2hour:function(t){return 12*t/Math.PI}},C=Math.pow(.01720209895,2),S=function(t,e,r){var s,i,o,h={},d=["a","e","i","w","M","L","W","N","n"];for(r&&(C=r),e&&(s=e instanceof Date?e:n(e)),s||(s=new Date),h.jd=f(s),s=n(t.ep),h.jd0=f(s),h.d=h.jd-h.jd0,h.cy=h.d/36525,i=0;i<d.length;i++)o=d[i],a(t,"d"+o)?h[o]=t[o]+t["d"+o]*h.cy:a(t,o)&&(h[o]=t[o]),a(h,o)&&(-1===o.search(/a|e/)?h[o]*=Math.PI/180:h[o]*=1);return a(h,"M")&&!a(h,"dM")&&a(h,"n")&&(h.M+=h.n*h.d),u(h),c(h),l(h),h},U=function(t,e){var n=B(t,e.elements);if(!a(e.elements[n],"d")){var r=e.elements[n],s=S(r,t),i={name:e.name,pos:[s.x,s.y,s.z],elements:e.elements};return e.H&&""!==e.H?i.r=12-e.H:e.r&&""!==e.r?i.r=e.r:i.r=20,e.icon&&""!==e.icon&&(i.icon=e.icon),i}},L=function(t,e){var n=B(t,e);if(!a(e[n],"d")){var r=S(e[n],t);return[r.x,r.y,r.z]}},B=function(t,e){var a=0;if(e.length>1)for(var n=0;n<e.length;n++)if(s(new Date(Date.parse(e[n].ep)),t)<=0){a=0===n?0:n-1;break}return a},F=function(t,e){for(var a,n=e.elements[0],i=[],o=S(n,t),h=o.P,c=r(t,h,"y"),u=s(t,c)/45/o.a,l=new Date(t.valueOf());s(l,c)>0;)a=S(n,l),i.push([a.x,a.y,a.z]),l=r(l,u);return i.push([o.x,o.y,o.z]),i},Y={width:0,height:0,container:"map",datapath:"data/",imagepath:"img/",planets:{show:!0,image:!0,trajectory:!0,size:null},sbos:{show:!0,image:!1,text:!0,trajectory:!1,size:null},spacecraft:{show:!1,image:!1,text:!0,trajectory:!1,size:null},other:[],set:function(t){var e,n={};if(!t)return this;for(var r in this)if(a(this,r)&&"function"!=typeof this[r])if(a(t,r)&&null!==t[r])if(null===this[r]||this[r].constructor!=Object)n[r]=t[r];else{n[r]={};for(e in this[r])a(t[r],e)?n[r][e]=t[r][e]:n[r][e]=this[r][e]}else n[r]=this[r];return n}},G={version:"0.2",svg:null},J=60,K=[30,0,90],Q=[],R=[],V=[],X=[],Z=d3.behavior.zoom().center([0,0]).scaleExtent([1,150]).scale(J).on("zoom",g),$=d3.svg.line().x(function(t){return t[0]}).y(function(t){return t[1]}),_=function(t){var e,a;for(e=0;e<Q.length;e++)a=L(t,Q[e].elements),a&&(Q[e].pos=a);for(e=0;e<R.length;e++)a=L(t,R[e].elements),a&&(R[e].pos=a);for(e=0;e<V.length;e++)a=L(t,V[e].elements),a&&(V[e].pos=a);g()},tt=function(n,r){var s=r||new Date,i=null;if(x=Y.set(n),z=t(x.container)){i="#"+x.container;var o=window.getComputedStyle(z,null);parseInt(o.width)||x.width||(z.style.width=e(window.innerWidth)),parseInt(o.height)||x.height||(z.style.height=e(window.innerHeight))}else i="body",z=null;P=z?z.clientWidth:window.innerWidth,j=z?z.clientHeight:window.innerHeight,b=N(K),y=d3.scale.linear().domain([-P/2,P/2]).range([-360,360]),v=d3.scale.linear().domain([-j/2,j/2]).range([90,-90]).clamp(!0),w=d3.select(i).append("svg").attr("width",P).attr("height",j).call(Z),m=w.append("g").attr("transform","translate("+P/2+","+j/2+")");var h=Math.pow(J,.8);I=m.append("image").attr({"xlink:href":"img/sun.png",x:-h/2,y:-h/2,width:h,height:h}),x.planets.show&&d3.json("data/planets.json",function(t,e){if(t)return console.log(t);for(var n in e)a(e,n)&&(Q.push(U(s,e[n])),x.planets.trajectory&&a(e[n],"trajectory")&&X.push(F(s,e[n])));x.planets.trajectory&&(H=M(X),q=m.selectAll(".tracks").data(H).enter().append("path").attr("class","dot").attr("d",$)),k=m.selectAll(".planets").data(Q),x.planets.image?k.enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",p).attr("class","planet").attr("width",function(t){return"Saturn"==t.name?2.7*t.r:t.r}).attr("height",function(t){return t.r}):k.enter().append("path").attr("transform",p).attr("class","planet").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),x.sbos.show&&d3.json("data/sbo.json",function(t,e){if(t)return console.log(t);for(var n in e)a(e,n)&&e[n].H<11&&R.push(U(s,e[n]));E=m.selectAll(".sbos").data(R).enter().append("path").attr("transform",p).attr("class","sbo").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),x.spacecraft.show&&d3.json("data/probes.json",function(t,e){if(t)return console.log(t);for(var n in e)if(a(e,n)){var r=U(s,e[n]);r&&V.push(r)}D=m.selectAll(".probes").data(V),x.spacecraft.image?D.enter().append("image").attr("xlink:href",function(t){return"img/"+t.icon}).attr("transform",p).attr("class","sc").attr("width",function(t){return t.r}).attr("height",function(t){return t.r}):D.enter().append("path").attr("transform",p).attr("class","sc").attr("d",d3.svg.symbol().size(function(t){return t.r}))}),d3.select(window).on("resize",d)};G.display=tt,G.update=_,this.Orrery=G}();